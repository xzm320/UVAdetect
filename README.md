# 基于CNN-Transformer的多模态无人机故障检测系统

## 项目简介

本项目实现了一个基于深度学习的多模态无人机故障检测系统，使用CNN-Transformer混合架构对无人机飞行数据进行故障分类。系统能够同时处理多通道时序信号和小波变换生成的时频图，通过多模态特征融合实现高精度的故障检测。

## 核心技术

- **多模态学习**：同时处理时序信号和时频图像数据
- **CNN-Transformer架构**：结合卷积神经网络的局部特征提取能力和Transformer的全局建模能力
- **小波变换**：将时序信号转换为时频域表示，增强特征表达能力
- **注意力机制**：通过多头自注意力机制捕获时序数据中的长距离依赖关系

## 文件结构

```
code/
├── README.md                           # 项目说明文档
├── requirements.txt                    # 依赖包列表
├── raw_data/                           # 原始无人机飞行数据 (3000+ CSV文件)
├── ipt/                               # 预处理后的数据
│   ├── dataset.npz                    # 标准化后的时序数据 (N, 41, 32)
│   ├── wavelet_dataset.npz            # 小波变换时频图数据 (N, 31, 41, 41)
│   ├── X.npy                         # 时序特征数据
│   └── y.npy                         # 标签数据
├── fig/                               # 训练过程可视化
│   └── loss_curve.png                # 训练和验证损失曲线
├── data_process.py                    # 数据预处理脚本
├── wavelet_transform.py               # 小波变换处理脚本
├── cnn_transformer_model.py           # 模型架构定义
├── train_cnn_transformer.py           # 模型训练脚本
└── cnn_transformer_checkpoint.pth     # 训练好的模型权重
```

## 核心模块说明

### 1. 数据预处理 (`data_process.py`)

**功能**：处理原始CSV格式的无人机飞行数据，提取特征并进行标准化。

**技术实现**：
- 从CSV文件名中解析故障代码，映射为4类故障标签
- 基于AU列的状态跃迁（0→1）确定关键时间窗口，提取41个时间步的数据段
- 选择32个关键传感器特征列（包括姿态、位置、速度、电机转速等）
- 对字符串格式数据进行清洗和类型转换
- 使用Z-score标准化处理特征数据

**输出**：`(N, 41, 32)`形状的三维数组，其中N为样本数，41为时间步长，32为特征维度

### 2. 小波变换 (`wavelet_transform.py`)

**功能**：将时序信号转换为时频域表示，生成小波变换时频图。

**技术实现**：
- 使用PyWavelets库的连续小波变换(CWT)，采用Morlet小波
- 对31个传感器通道分别进行小波变换（排除时间列）
- 生成`(31, 41, 41)`的时频图，其中31为通道数，41×41为时频分辨率
- 通过逐通道标准化确保数据分布的一致性

**输出**：`(N, 31, 41, 41)`形状的四维数组，适用于CNN处理

### 3. 模型架构 (`cnn_transformer_model.py`)

**核心组件**：

#### SignalTransformer
- 处理多通道时序信号的Transformer编码器
- 通过线性投影将32维特征映射到64维嵌入空间
- 使用位置编码和多头自注意力机制捕获时序依赖
- 采用3层Transformer编码器，8个注意力头

#### CWT_CNN_Transformer
- 先用CNN提取时频图的空间特征
- 两层卷积+池化操作，通道数逐步增加到32
- 将CNN输出展平为序列，输入Transformer进行全局建模
- 嵌入维度96，3层编码器结构

#### MultiModalClassifier
- 整合两路特征进行多模态融合
- 全局平均池化聚合序列特征
- 三层全连接分类器，包含Dropout正则化
- 输出4类故障预测结果

**数据流**：
```
时序信号 (B,41,32) → SignalTransformer → 特征1 (B,64)
                                              ↓
时频图 (B,31,41,41) → CWT_CNN_Transformer → 特征2 (B,96) → 拼接 → 分类器 → 预测 (B,4)
```

### 4. 训练脚本 (`train_cnn_transformer.py`)

**训练策略**：
- 针对数据不平衡问题使用加权交叉熵损失函数
- AdamW优化器，学习率2e-4，权重衰减1e-4
- 余弦退火学习率调度，动态调整学习率
- 批大小128，训练50个epoch

**正则化技术**：
- Dropout层防止过拟合（比例0.3-0.4）
- 批标准化稳定训练过程
- 权重衰减控制模型复杂度

## 故障类型

| 故障代码 | 标签 | 描述 | 样本数量 |
|---------|------|------|----------|
| 00      | 0    | 正常状态 | 1,760 |
| 01      | 1    | 故障类型1 | 870 |
| 02      | 2    | 故障类型2 | 72 |
| 10      | 3    | 故障类型3 | 480 |

## 环境要求

- Python 3.8+
- CUDA 11.0+（可选，用于GPU加速）
- 内存建议8GB以上
- 存储空间5GB以上

## 安装和使用

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 数据预处理

```bash
# 处理原始CSV数据，生成标准化的时序数据
python data_process.py

# 生成小波变换时频图数据
python wavelet_transform.py
```

### 3. 模型训练

```bash
# 使用默认参数训练
python train_cnn_transformer.py

# 自定义训练参数
python train_cnn_transformer.py --epochs 100 --batch_size 64 --lr 1e-4
```

### 4. 训练监控

训练过程中会自动生成：
- `fig/loss_curve.png`：训练和验证损失曲线
- `cnn_transformer_checkpoint.pth`：模型权重文件

## 技术特色

1. **多模态融合**：结合时域和频域信息，提升故障检测的鲁棒性
2. **注意力机制**：自动学习关键时间点和特征通道的重要性
3. **端到端训练**：从原始传感器数据到故障分类的完整pipeline
4. **数据增强**：通过小波变换增加数据的特征表达维度
5. **不平衡处理**：针对故障样本稀少的实际情况设计加权损失

## 性能指标

- 模型参数量：约0.42M
- 内存占用：约2GB（训练时）

## 扩展说明

本系统设计具有良好的可扩展性，可以通过以下方式进行改进：
- 增加更多传感器通道的数据
- 尝试不同的小波基函数
- 调整网络架构的深度和宽度
- 引入更多的数据增强技术
- 集成更多的故障类型

## 技术参考

- Transformer架构：[Attention Is All You Need](https://arxiv.org/abs/1706.03762)
- 小波变换：PyWavelets库文档
- 多模态学习：深度学习中的特征融合技术